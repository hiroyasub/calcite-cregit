begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to you under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  * http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|adapter
operator|.
name|enumerable
operator|.
name|EnumerableConvention
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|adapter
operator|.
name|enumerable
operator|.
name|EnumerableHashJoin
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|adapter
operator|.
name|enumerable
operator|.
name|EnumerableRules
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|Convention
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|RelOptCluster
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|RelOptRuleCall
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|RelOptUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|RelRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|hep
operator|.
name|HepPlanner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|hep
operator|.
name|HepProgram
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|hep
operator|.
name|HepProgramBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|plan
operator|.
name|volcano
operator|.
name|AbstractConverter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|RelCollationTraitDef
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|RelNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|RelShuttleImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|RelVisitor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|convert
operator|.
name|ConverterRule
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|Aggregate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|Calc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|Filter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|Join
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|JoinInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|Snapshot
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|TableScan
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|core
operator|.
name|Window
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|hint
operator|.
name|HintPredicate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|hint
operator|.
name|HintPredicates
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|hint
operator|.
name|HintStrategy
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|hint
operator|.
name|HintStrategyTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|hint
operator|.
name|Hintable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|hint
operator|.
name|RelHint
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalAggregate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalCorrelate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalFilter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalIntersect
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalJoin
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalMinus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalProject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalSort
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalUnion
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|logical
operator|.
name|LogicalValues
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|rules
operator|.
name|CoreRules
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlDelete
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlInsert
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlMerge
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlNodeList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlTableRef
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlUpdate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|test
operator|.
name|SqlTestFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|test
operator|.
name|SqlTester
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|tools
operator|.
name|RuleSet
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|tools
operator|.
name|RuleSets
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|util
operator|.
name|Litmus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|util
operator|.
name|Util
import|;
end_import

begin_import
import|import
name|org
operator|.
name|checkerframework
operator|.
name|checker
operator|.
name|nullness
operator|.
name|qual
operator|.
name|Nullable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|immutables
operator|.
name|value
operator|.
name|Value
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|jupiter
operator|.
name|api
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Locale
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|Predicate
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|UnaryOperator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Collectors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|stream
operator|.
name|Stream
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
operator|.
name|Matchers
operator|.
name|relIsValid
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
operator|.
name|SqlToRelTestBase
operator|.
name|NL
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|MatcherAssert
operator|.
name|assertThat
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|collection
operator|.
name|IsIn
operator|.
name|in
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|hamcrest
operator|.
name|core
operator|.
name|Is
operator|.
name|is
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|jupiter
operator|.
name|api
operator|.
name|Assertions
operator|.
name|assertArrayEquals
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|jupiter
operator|.
name|api
operator|.
name|Assertions
operator|.
name|assertNotNull
import|;
end_import

begin_import
import|import static
name|org
operator|.
name|junit
operator|.
name|jupiter
operator|.
name|api
operator|.
name|Assertions
operator|.
name|fail
import|;
end_import

begin_import
import|import static
name|java
operator|.
name|util
operator|.
name|Objects
operator|.
name|requireNonNull
import|;
end_import

begin_comment
comment|/**  * Unit test for {@link org.apache.calcite.rel.hint.RelHint}.  */
end_comment

begin_class
class|class
name|SqlHintsConverterTest
block|{
specifier|static
specifier|final
name|Fixture
name|FIXTURE
init|=
operator|new
name|Fixture
argument_list|(
name|SqlTestFactory
operator|.
name|INSTANCE
argument_list|,
name|DiffRepository
operator|.
name|lookup
argument_list|(
name|SqlHintsConverterTest
operator|.
name|class
argument_list|)
argument_list|,
literal|"?"
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
operator|.
name|withFactory
argument_list|(
name|f
lambda|->
name|f
operator|.
name|withSqlToRelConfig
argument_list|(
name|c
lambda|->
name|c
operator|.
name|withHintStrategyTable
argument_list|(
name|HintTools
operator|.
name|HINT_STRATEGY_TABLE
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|RelOptFixture
name|RULE_FIXTURE
init|=
name|RelOptFixture
operator|.
name|DEFAULT
operator|.
name|withDiffRepos
argument_list|(
name|DiffRepository
operator|.
name|lookup
argument_list|(
name|SqlHintsConverterTest
operator|.
name|class
argument_list|)
argument_list|)
operator|.
name|withConfig
argument_list|(
name|c
lambda|->
name|c
operator|.
name|withHintStrategyTable
argument_list|(
name|HintTools
operator|.
name|HINT_STRATEGY_TABLE
argument_list|)
argument_list|)
decl_stmt|;
specifier|protected
name|Fixture
name|fixture
parameter_list|()
block|{
return|return
name|FIXTURE
return|;
block|}
specifier|protected
name|RelOptFixture
name|ruleFixture
parameter_list|()
block|{
return|return
name|RULE_FIXTURE
return|;
block|}
comment|/** Sets the SQL statement for a test. */
specifier|public
specifier|final
name|Fixture
name|sql
parameter_list|(
name|String
name|sql
parameter_list|)
block|{
return|return
name|fixture
argument_list|()
operator|.
name|sql
argument_list|(
name|sql
argument_list|)
return|;
block|}
comment|//~ Tests ------------------------------------------------------------------
annotation|@
name|Test
name|void
name|testQueryHint
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
name|HintTools
operator|.
name|withHint
argument_list|(
literal|"select /*+ %s */ *\n"
operator|+
literal|"from emp e1\n"
operator|+
literal|"inner join dept d1 on e1.deptno = d1.deptno\n"
operator|+
literal|"inner join emp e2 on e1.ename = e2.job"
argument_list|)
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testQueryHintWithLiteralOptions
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ time_zone(1, 1.23, 'a bc', -1.0) */ *\n"
operator|+
literal|"from emp"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testNestedQueryHint
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3'), repartition(10) */ empno\n"
operator|+
literal|"from (select /*+ resource(mem='20Mb')*/ empno, ename from emp)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTwoLevelNestedQueryHint
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3'), no_hash_join */ empno\n"
operator|+
literal|"from (select /*+ resource(mem='20Mb')*/ empno, ename\n"
operator|+
literal|"from emp left join dept on emp.deptno = dept.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testThreeLevelNestedQueryHint
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ index(idx1), no_hash_join */ * from emp /*+ index(empno) */\n"
operator|+
literal|"e1 join dept/*+ index(deptno) */ d1 on e1.deptno = d1.deptno\n"
operator|+
literal|"join emp e2 on d1.name = e2.job"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testFourLevelNestedQueryHint
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ index(idx1), no_hash_join */ * from emp /*+ index(empno) */\n"
operator|+
literal|"e1 join dept/*+ index(deptno) */ d1 on e1.deptno = d1.deptno join\n"
operator|+
literal|"(select max(sal) as sal from emp /*+ index(empno) */) e2 on e1.sal = e2.sal"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testAggregateHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ AGG_STRATEGY(TWO_PHASE), RESOURCE(mem='1024') */\n"
operator|+
literal|"count(deptno), avg_sal from (\n"
operator|+
literal|"select /*+ AGG_STRATEGY(ONE_PHASE) */ avg(sal) as avg_sal, deptno\n"
operator|+
literal|"from emp group by deptno) group by avg_sal"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testCorrelateHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ use_hash_join (orders, products_temporal) */ stream *\n"
operator|+
literal|"from orders join products_temporal for system_time as of orders.rowtime\n"
operator|+
literal|"on orders.productid = products_temporal.productid and orders.orderId is not null"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testCrossCorrelateHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ use_hash_join (orders, products_temporal) */ stream *\n"
operator|+
literal|"from orders, products_temporal for system_time as of orders.rowtime"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testFilterHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3') */ avg(sal) as avg_sal, deptno\n"
operator|+
literal|"from emp group by deptno having avg(sal)> 5000"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testUnionHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ breakable */ deptno from\n"
operator|+
literal|"(select ename, deptno from emp\n"
operator|+
literal|"union all\n"
operator|+
literal|"select name, deptno from dept)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testMinusHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ breakable */ deptno from\n"
operator|+
literal|"(select ename, deptno from emp\n"
operator|+
literal|"except all\n"
operator|+
literal|"select name, deptno from dept)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testIntersectHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ breakable */ deptno from\n"
operator|+
literal|"(select ename, deptno from emp\n"
operator|+
literal|"intersect all\n"
operator|+
literal|"select name, deptno from dept)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testSortHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ async_merge */ empno from emp order by empno, empno desc"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testValuesHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3') */ a, max(b), max(b + 1)\n"
operator|+
literal|"from (values (1, 2)) as t(a, b)\n"
operator|+
literal|"group by a"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testWindowHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ mini_batch */ last_value(deptno)\n"
operator|+
literal|"over (order by empno rows 2 following) from emp"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsInSubQueryWithDecorrelation
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3'), AGG_STRATEGY(TWO_PHASE) */\n"
operator|+
literal|"sum(e1.empno) from emp e1, dept d1\n"
operator|+
literal|"where e1.deptno = d1.deptno\n"
operator|+
literal|"and e1.sal> (\n"
operator|+
literal|"select /*+ resource(cpu='2') */ avg(e2.sal) from emp e2 where e2.deptno = d1.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|withDecorrelate
argument_list|(
literal|true
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsInSubQueryWithDecorrelation2
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ properties(k1='v1', k2='v2'), index(ename), no_hash_join */\n"
operator|+
literal|"sum(e1.empno) from emp e1, dept d1\n"
operator|+
literal|"where e1.deptno = d1.deptno\n"
operator|+
literal|"and e1.sal> (\n"
operator|+
literal|"select /*+ properties(k1='v1', k2='v2'), index(ename), no_hash_join */\n"
operator|+
literal|"  avg(e2.sal)\n"
operator|+
literal|"  from emp e2\n"
operator|+
literal|"  where e2.deptno = d1.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|withDecorrelate
argument_list|(
literal|true
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsInSubQueryWithDecorrelation3
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3'), index(ename), no_hash_join */\n"
operator|+
literal|"sum(e1.empno) from emp e1, dept d1\n"
operator|+
literal|"where e1.deptno = d1.deptno\n"
operator|+
literal|"and e1.sal> (\n"
operator|+
literal|"select /*+ resource(cpu='2'), index(ename), no_hash_join */\n"
operator|+
literal|"  avg(e2.sal)\n"
operator|+
literal|"  from emp e2\n"
operator|+
literal|"  where e2.deptno = d1.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|withDecorrelate
argument_list|(
literal|true
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsInSubQueryWithoutDecorrelation
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(parallelism='3') */\n"
operator|+
literal|"sum(e1.empno) from emp e1, dept d1\n"
operator|+
literal|"where e1.deptno = d1.deptno\n"
operator|+
literal|"and e1.sal> (\n"
operator|+
literal|"select /*+ resource(cpu='2') */ avg(e2.sal) from emp e2 where e2.deptno = d1.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testInvalidQueryHint
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ weird_hint */ empno\n"
operator|+
literal|"from (select /*+ resource(mem='20Mb')*/ empno, ename\n"
operator|+
literal|"from emp left join dept on emp.deptno = dept.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|warns
argument_list|(
literal|"Hint: WEIRD_HINT should be registered in the HintStrategyTable"
argument_list|)
expr_stmt|;
specifier|final
name|String
name|sql1
init|=
literal|"select /*+ resource(mem='20Mb')*/ empno\n"
operator|+
literal|"from (select /*+ weird_kv_hint(k1='v1') */ empno, ename\n"
operator|+
literal|"from emp left join dept on emp.deptno = dept.deptno)"
decl_stmt|;
name|sql
argument_list|(
name|sql1
argument_list|)
operator|.
name|warns
argument_list|(
literal|"Hint: WEIRD_KV_HINT should be registered in the HintStrategyTable"
argument_list|)
expr_stmt|;
specifier|final
name|String
name|sql2
init|=
literal|"select /*+ AGG_STRATEGY(OPTION1) */\n"
operator|+
literal|"ename, avg(sal)\n"
operator|+
literal|"from emp group by ename"
decl_stmt|;
specifier|final
name|String
name|error2
init|=
literal|"Hint AGG_STRATEGY only allows single option, "
operator|+
literal|"allowed options: [ONE_PHASE, TWO_PHASE]"
decl_stmt|;
name|sql
argument_list|(
name|sql2
argument_list|)
operator|.
name|warns
argument_list|(
name|error2
argument_list|)
expr_stmt|;
comment|// Change the error handler to validate again.
name|sql
argument_list|(
name|sql2
argument_list|)
operator|.
name|withFactory
argument_list|(
name|f
lambda|->
name|f
operator|.
name|withSqlToRelConfig
argument_list|(
name|c
lambda|->
name|c
operator|.
name|withHintStrategyTable
argument_list|(
name|HintTools
operator|.
name|createHintStrategies
argument_list|(
name|HintStrategyTable
operator|.
name|builder
argument_list|()
operator|.
name|errorHandler
argument_list|(
name|Litmus
operator|.
name|THROW
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|fails
argument_list|(
name|error2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTableHintsInJoin
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp /*+ index(idx1, idx2) */\n"
operator|+
literal|"join dept /*+ properties(k1='v1', k2='v2') */\n"
operator|+
literal|"on emp.deptno = dept.deptno"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTableHintsInSelect
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
name|HintTools
operator|.
name|withHint
argument_list|(
literal|"select * from emp /*+ %s */"
argument_list|)
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testSameHintsWithDifferentInheritPath
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ properties(k1='v1', k2='v2') */\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp /*+ index(idx1, idx2) */\n"
operator|+
literal|"join dept /*+ properties(k1='v1', k2='v2') */\n"
operator|+
literal|"on emp.deptno = dept.deptno"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTableHintsInInsert
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|String
name|sql
init|=
name|HintTools
operator|.
name|withHint
argument_list|(
literal|"insert into dept /*+ %s */ (deptno, name) "
operator|+
literal|"select deptno, name from dept"
argument_list|)
decl_stmt|;
specifier|final
name|SqlInsert
name|insert
init|=
operator|(
name|SqlInsert
operator|)
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|parseQuery
argument_list|()
decl_stmt|;
assert|assert
name|insert
operator|.
name|getTargetTable
argument_list|()
operator|instanceof
name|SqlTableRef
assert|;
specifier|final
name|SqlTableRef
name|tableRef
init|=
operator|(
name|SqlTableRef
operator|)
name|insert
operator|.
name|getTargetTable
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|RelHint
argument_list|>
name|hints
init|=
name|SqlUtil
operator|.
name|getRelHint
argument_list|(
name|HintTools
operator|.
name|HINT_STRATEGY_TABLE
argument_list|,
operator|(
name|SqlNodeList
operator|)
name|tableRef
operator|.
name|getOperandList
argument_list|()
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|assertHintsEquals
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|HintTools
operator|.
name|PROPS_HINT
argument_list|,
name|HintTools
operator|.
name|IDX_HINT
argument_list|,
name|HintTools
operator|.
name|JOIN_HINT
argument_list|)
argument_list|,
name|hints
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTableHintsInUpdate
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|String
name|sql
init|=
name|HintTools
operator|.
name|withHint
argument_list|(
literal|"update emp /*+ %s */ "
operator|+
literal|"set name = 'test' where deptno = 1"
argument_list|)
decl_stmt|;
specifier|final
name|SqlUpdate
name|sqlUpdate
init|=
operator|(
name|SqlUpdate
operator|)
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|parseQuery
argument_list|()
decl_stmt|;
assert|assert
name|sqlUpdate
operator|.
name|getTargetTable
argument_list|()
operator|instanceof
name|SqlTableRef
assert|;
specifier|final
name|SqlTableRef
name|tableRef
init|=
operator|(
name|SqlTableRef
operator|)
name|sqlUpdate
operator|.
name|getTargetTable
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|RelHint
argument_list|>
name|hints
init|=
name|SqlUtil
operator|.
name|getRelHint
argument_list|(
name|HintTools
operator|.
name|HINT_STRATEGY_TABLE
argument_list|,
operator|(
name|SqlNodeList
operator|)
name|tableRef
operator|.
name|getOperandList
argument_list|()
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|assertHintsEquals
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|HintTools
operator|.
name|PROPS_HINT
argument_list|,
name|HintTools
operator|.
name|IDX_HINT
argument_list|,
name|HintTools
operator|.
name|JOIN_HINT
argument_list|)
argument_list|,
name|hints
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTableHintsInDelete
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|String
name|sql
init|=
name|HintTools
operator|.
name|withHint
argument_list|(
literal|"delete from emp /*+ %s */ where deptno = 1"
argument_list|)
decl_stmt|;
specifier|final
name|SqlDelete
name|sqlDelete
init|=
operator|(
name|SqlDelete
operator|)
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|parseQuery
argument_list|()
decl_stmt|;
assert|assert
name|sqlDelete
operator|.
name|getTargetTable
argument_list|()
operator|instanceof
name|SqlTableRef
assert|;
specifier|final
name|SqlTableRef
name|tableRef
init|=
operator|(
name|SqlTableRef
operator|)
name|sqlDelete
operator|.
name|getTargetTable
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|RelHint
argument_list|>
name|hints
init|=
name|SqlUtil
operator|.
name|getRelHint
argument_list|(
name|HintTools
operator|.
name|HINT_STRATEGY_TABLE
argument_list|,
operator|(
name|SqlNodeList
operator|)
name|tableRef
operator|.
name|getOperandList
argument_list|()
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|assertHintsEquals
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|HintTools
operator|.
name|PROPS_HINT
argument_list|,
name|HintTools
operator|.
name|IDX_HINT
argument_list|,
name|HintTools
operator|.
name|JOIN_HINT
argument_list|)
argument_list|,
name|hints
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testTableHintsInMerge
parameter_list|()
throws|throws
name|Exception
block|{
specifier|final
name|String
name|sql
init|=
literal|"merge into emps\n"
operator|+
literal|"/*+ %s */ e\n"
operator|+
literal|"using tempemps as t\n"
operator|+
literal|"on e.empno = t.empno\n"
operator|+
literal|"when matched then update\n"
operator|+
literal|"set name = t.name, deptno = t.deptno, salary = t.salary * .1\n"
operator|+
literal|"when not matched then insert (name, dept, salary)\n"
operator|+
literal|"values(t.name, 10, t.salary * .15)"
decl_stmt|;
specifier|final
name|String
name|sql1
init|=
name|HintTools
operator|.
name|withHint
argument_list|(
name|sql
argument_list|)
decl_stmt|;
specifier|final
name|SqlMerge
name|sqlMerge
init|=
operator|(
name|SqlMerge
operator|)
name|sql
argument_list|(
name|sql1
argument_list|)
operator|.
name|parseQuery
argument_list|()
decl_stmt|;
assert|assert
name|sqlMerge
operator|.
name|getTargetTable
argument_list|()
operator|instanceof
name|SqlTableRef
assert|;
specifier|final
name|SqlTableRef
name|tableRef
init|=
operator|(
name|SqlTableRef
operator|)
name|sqlMerge
operator|.
name|getTargetTable
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|RelHint
argument_list|>
name|hints
init|=
name|SqlUtil
operator|.
name|getRelHint
argument_list|(
name|HintTools
operator|.
name|HINT_STRATEGY_TABLE
argument_list|,
operator|(
name|SqlNodeList
operator|)
name|tableRef
operator|.
name|getOperandList
argument_list|()
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
decl_stmt|;
name|assertHintsEquals
argument_list|(
name|Arrays
operator|.
name|asList
argument_list|(
name|HintTools
operator|.
name|PROPS_HINT
argument_list|,
name|HintTools
operator|.
name|IDX_HINT
argument_list|,
name|HintTools
operator|.
name|JOIN_HINT
argument_list|)
argument_list|,
name|hints
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testInvalidTableHints
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp /*+ weird_hint(idx1, idx2) */\n"
operator|+
literal|"join dept /*+ properties(k1='v1', k2='v2') */\n"
operator|+
literal|"on emp.deptno = dept.deptno"
decl_stmt|;
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|warns
argument_list|(
literal|"Hint: WEIRD_HINT should be registered in the HintStrategyTable"
argument_list|)
expr_stmt|;
specifier|final
name|String
name|sql1
init|=
literal|"select\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp /*+ index(idx1, idx2) */\n"
operator|+
literal|"join dept /*+ weird_kv_hint(k1='v1', k2='v2') */\n"
operator|+
literal|"on emp.deptno = dept.deptno"
decl_stmt|;
name|sql
argument_list|(
name|sql1
argument_list|)
operator|.
name|warns
argument_list|(
literal|"Hint: WEIRD_KV_HINT should be registered in the HintStrategyTable"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testJoinHintRequiresSpecificInputs
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ use_hash_join(r, s), use_hash_join(emp, dept) */\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp join dept on emp.deptno = dept.deptno"
decl_stmt|;
comment|// Hint use_hash_join(r, s) expect to be ignored by the join node.
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|ok
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsForCalc
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ resource(mem='1024MB')*/ ename, sal, deptno from emp"
decl_stmt|;
specifier|final
name|RelNode
name|rel
init|=
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|toRel
argument_list|()
decl_stmt|;
specifier|final
name|RelHint
name|hint
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"RESOURCE"
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"MEM"
argument_list|,
literal|"1024MB"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
comment|// planner rule to convert Project to Calc.
name|HepProgram
name|program
init|=
operator|new
name|HepProgramBuilder
argument_list|()
operator|.
name|addRuleInstance
argument_list|(
name|CoreRules
operator|.
name|PROJECT_TO_CALC
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|HepPlanner
name|planner
init|=
operator|new
name|HepPlanner
argument_list|(
name|program
argument_list|)
decl_stmt|;
name|planner
operator|.
name|setRoot
argument_list|(
name|rel
argument_list|)
expr_stmt|;
name|RelNode
name|newRel
init|=
name|planner
operator|.
name|findBestExp
argument_list|()
decl_stmt|;
operator|new
name|ValidateHintVisitor
argument_list|(
name|hint
argument_list|,
name|Calc
operator|.
name|class
argument_list|)
operator|.
name|go
argument_list|(
name|newRel
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsPropagationInHepPlannerRules
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ use_hash_join(r, s), use_hash_join(emp, dept) */\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp join dept on emp.deptno = dept.deptno"
decl_stmt|;
specifier|final
name|RelNode
name|rel
init|=
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|toRel
argument_list|()
decl_stmt|;
specifier|final
name|RelHint
name|hint
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"USE_HASH_JOIN"
argument_list|)
operator|.
name|inheritPath
argument_list|(
literal|0
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"EMP"
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"DEPT"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
comment|// Validate Hep planner.
name|HepProgram
name|program
init|=
operator|new
name|HepProgramBuilder
argument_list|()
operator|.
name|addRuleInstance
argument_list|(
name|MockJoinRule
operator|.
name|INSTANCE
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|HepPlanner
name|planner
init|=
operator|new
name|HepPlanner
argument_list|(
name|program
argument_list|)
decl_stmt|;
name|planner
operator|.
name|setRoot
argument_list|(
name|rel
argument_list|)
expr_stmt|;
name|RelNode
name|newRel
init|=
name|planner
operator|.
name|findBestExp
argument_list|()
decl_stmt|;
operator|new
name|ValidateHintVisitor
argument_list|(
name|hint
argument_list|,
name|Join
operator|.
name|class
argument_list|)
operator|.
name|go
argument_list|(
name|newRel
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsPropagationInVolcanoPlannerRules
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ use_hash_join(r, s), use_hash_join(emp, dept) */\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp join dept on emp.deptno = dept.deptno"
decl_stmt|;
specifier|final
name|RelHint
name|hint
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"USE_HASH_JOIN"
argument_list|)
operator|.
name|inheritPath
argument_list|(
literal|0
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"EMP"
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"DEPT"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
comment|// Validate Volcano planner.
name|RuleSet
name|ruleSet
init|=
name|RuleSets
operator|.
name|ofList
argument_list|(
name|MockEnumerableJoinRule
operator|.
name|create
argument_list|(
name|hint
argument_list|)
argument_list|,
comment|// Rule to validate the hint.
name|CoreRules
operator|.
name|FILTER_PROJECT_TRANSPOSE
argument_list|,
name|CoreRules
operator|.
name|FILTER_MERGE
argument_list|,
name|CoreRules
operator|.
name|PROJECT_MERGE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_JOIN_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_PROJECT_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_FILTER_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_SORT_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_LIMIT_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_TABLE_SCAN_RULE
argument_list|)
decl_stmt|;
name|ruleFixture
argument_list|()
operator|.
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|withVolcanoPlanner
argument_list|(
literal|false
argument_list|,
name|p
lambda|->
block|{
name|p
operator|.
name|addRelTraitDef
argument_list|(
name|RelCollationTraitDef
operator|.
name|INSTANCE
argument_list|)
expr_stmt|;
name|RelOptUtil
operator|.
name|registerDefaultRules
argument_list|(
name|p
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|ruleSet
operator|.
name|forEach
argument_list|(
name|p
operator|::
name|addRule
argument_list|)
expr_stmt|;
block|}
argument_list|)
operator|.
name|check
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testHintsPropagateWithDifferentKindOfRels
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ AGG_STRATEGY(TWO_PHASE) */\n"
operator|+
literal|"ename, avg(sal)\n"
operator|+
literal|"from emp group by ename"
decl_stmt|;
specifier|final
name|RelNode
name|rel
init|=
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|toRel
argument_list|()
decl_stmt|;
specifier|final
name|RelHint
name|hint
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"AGG_STRATEGY"
argument_list|)
operator|.
name|inheritPath
argument_list|(
literal|0
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"TWO_PHASE"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
comment|// AggregateReduceFunctionsRule does the transformation:
comment|// AGG -> PROJECT + AGG
name|HepProgram
name|program
init|=
operator|new
name|HepProgramBuilder
argument_list|()
operator|.
name|addRuleInstance
argument_list|(
name|CoreRules
operator|.
name|AGGREGATE_REDUCE_FUNCTIONS
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|HepPlanner
name|planner
init|=
operator|new
name|HepPlanner
argument_list|(
name|program
argument_list|)
decl_stmt|;
name|planner
operator|.
name|setRoot
argument_list|(
name|rel
argument_list|)
expr_stmt|;
name|RelNode
name|newRel
init|=
name|planner
operator|.
name|findBestExp
argument_list|()
decl_stmt|;
operator|new
name|ValidateHintVisitor
argument_list|(
name|hint
argument_list|,
name|Aggregate
operator|.
name|class
argument_list|)
operator|.
name|go
argument_list|(
name|newRel
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
name|void
name|testUseMergeJoin
parameter_list|()
block|{
specifier|final
name|String
name|sql
init|=
literal|"select /*+ use_merge_join(emp, dept) */\n"
operator|+
literal|"ename, job, sal, dept.name\n"
operator|+
literal|"from emp join dept on emp.deptno = dept.deptno"
decl_stmt|;
name|RuleSet
name|ruleSet
init|=
name|RuleSets
operator|.
name|ofList
argument_list|(
name|EnumerableRules
operator|.
name|ENUMERABLE_MERGE_JOIN_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_JOIN_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_PROJECT_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_TABLE_SCAN_RULE
argument_list|,
name|EnumerableRules
operator|.
name|ENUMERABLE_SORT_RULE
argument_list|,
name|AbstractConverter
operator|.
name|ExpandConversionRule
operator|.
name|INSTANCE
argument_list|)
decl_stmt|;
name|ruleFixture
argument_list|()
operator|.
name|sql
argument_list|(
name|sql
argument_list|)
operator|.
name|withVolcanoPlanner
argument_list|(
literal|false
argument_list|,
name|planner
lambda|->
block|{
name|planner
operator|.
name|addRelTraitDef
argument_list|(
name|RelCollationTraitDef
operator|.
name|INSTANCE
argument_list|)
expr_stmt|;
name|ruleSet
operator|.
name|forEach
argument_list|(
name|planner
operator|::
name|addRule
argument_list|)
expr_stmt|;
block|}
argument_list|)
operator|.
name|check
argument_list|()
expr_stmt|;
block|}
comment|//~ Methods ----------------------------------------------------------------
specifier|private
specifier|static
name|boolean
name|equalsStringList
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|l
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|r
parameter_list|)
block|{
if|if
condition|(
name|l
operator|.
name|size
argument_list|()
operator|!=
name|r
operator|.
name|size
argument_list|()
condition|)
block|{
return|return
literal|false
return|;
block|}
for|for
control|(
name|String
name|s
range|:
name|l
control|)
block|{
if|if
condition|(
operator|!
name|r
operator|.
name|contains
argument_list|(
name|s
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
block|}
return|return
literal|true
return|;
block|}
specifier|private
specifier|static
name|void
name|assertHintsEquals
parameter_list|(
name|List
argument_list|<
name|RelHint
argument_list|>
name|expected
parameter_list|,
name|List
argument_list|<
name|RelHint
argument_list|>
name|actual
parameter_list|)
block|{
name|assertArrayEquals
argument_list|(
name|expected
operator|.
name|toArray
argument_list|(
operator|new
name|RelHint
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|actual
operator|.
name|toArray
argument_list|(
operator|new
name|RelHint
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|//~ Inner Class ------------------------------------------------------------
comment|/** A Mock rule to validate the hint. */
specifier|public
specifier|static
class|class
name|MockJoinRule
extends|extends
name|RelRule
argument_list|<
name|MockJoinRule
operator|.
name|Config
argument_list|>
block|{
specifier|public
specifier|static
specifier|final
name|MockJoinRule
name|INSTANCE
init|=
name|ImmutableMockJoinRuleConfig
operator|.
name|builder
argument_list|()
operator|.
name|build
argument_list|()
operator|.
name|withOperandSupplier
argument_list|(
name|b
lambda|->
name|b
operator|.
name|operand
argument_list|(
name|LogicalJoin
operator|.
name|class
argument_list|)
operator|.
name|anyInputs
argument_list|()
argument_list|)
operator|.
name|withDescription
argument_list|(
literal|"MockJoinRule"
argument_list|)
operator|.
name|as
argument_list|(
name|Config
operator|.
name|class
argument_list|)
operator|.
name|toRule
argument_list|()
decl_stmt|;
name|MockJoinRule
parameter_list|(
name|Config
name|config
parameter_list|)
block|{
name|super
argument_list|(
name|config
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|onMatch
parameter_list|(
name|RelOptRuleCall
name|call
parameter_list|)
block|{
name|LogicalJoin
name|join
init|=
name|call
operator|.
name|rel
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|assertThat
argument_list|(
name|join
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|is
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|call
operator|.
name|transformTo
argument_list|(
name|LogicalJoin
operator|.
name|create
argument_list|(
name|join
operator|.
name|getLeft
argument_list|()
argument_list|,
name|join
operator|.
name|getRight
argument_list|()
argument_list|,
name|join
operator|.
name|getHints
argument_list|()
argument_list|,
name|join
operator|.
name|getCondition
argument_list|()
argument_list|,
name|join
operator|.
name|getVariablesSet
argument_list|()
argument_list|,
name|join
operator|.
name|getJoinType
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/** Rule configuration. */
annotation|@
name|Value
operator|.
name|Immutable
annotation|@
name|Value
operator|.
name|Style
argument_list|(
name|typeImmutable
operator|=
literal|"ImmutableMockJoinRuleConfig"
argument_list|)
specifier|public
interface|interface
name|Config
extends|extends
name|RelRule
operator|.
name|Config
block|{
annotation|@
name|Override
specifier|default
name|MockJoinRule
name|toRule
parameter_list|()
block|{
return|return
operator|new
name|MockJoinRule
argument_list|(
name|this
argument_list|)
return|;
block|}
block|}
block|}
comment|/** A Mock rule to validate the hint.    * This rule also converts the rel to EnumerableConvention. */
specifier|private
specifier|static
class|class
name|MockEnumerableJoinRule
extends|extends
name|ConverterRule
block|{
specifier|static
name|MockEnumerableJoinRule
name|create
parameter_list|(
name|RelHint
name|hint
parameter_list|)
block|{
return|return
name|Config
operator|.
name|INSTANCE
operator|.
name|withConversion
argument_list|(
name|LogicalJoin
operator|.
name|class
argument_list|,
name|Convention
operator|.
name|NONE
argument_list|,
name|EnumerableConvention
operator|.
name|INSTANCE
argument_list|,
literal|"MockEnumerableJoinRule"
argument_list|)
operator|.
name|withRuleFactory
argument_list|(
name|c
lambda|->
operator|new
name|MockEnumerableJoinRule
argument_list|(
name|c
argument_list|,
name|hint
argument_list|)
argument_list|)
operator|.
name|toRule
argument_list|(
name|MockEnumerableJoinRule
operator|.
name|class
argument_list|)
return|;
block|}
name|MockEnumerableJoinRule
parameter_list|(
name|Config
name|config
parameter_list|,
name|RelHint
name|hint
parameter_list|)
block|{
name|super
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|this
operator|.
name|expectedHint
operator|=
name|hint
expr_stmt|;
block|}
specifier|private
specifier|final
name|RelHint
name|expectedHint
decl_stmt|;
annotation|@
name|Override
specifier|public
name|RelNode
name|convert
parameter_list|(
name|RelNode
name|rel
parameter_list|)
block|{
name|LogicalJoin
name|join
init|=
operator|(
name|LogicalJoin
operator|)
name|rel
decl_stmt|;
name|assertThat
argument_list|(
name|join
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|is
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|join
operator|.
name|getHints
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|is
argument_list|(
name|expectedHint
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|RelNode
argument_list|>
name|newInputs
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|RelNode
name|input
range|:
name|join
operator|.
name|getInputs
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|input
operator|.
name|getConvention
argument_list|()
operator|instanceof
name|EnumerableConvention
operator|)
condition|)
block|{
name|input
operator|=
name|convert
argument_list|(
name|input
argument_list|,
name|input
operator|.
name|getTraitSet
argument_list|()
operator|.
name|replace
argument_list|(
name|EnumerableConvention
operator|.
name|INSTANCE
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|newInputs
operator|.
name|add
argument_list|(
name|input
argument_list|)
expr_stmt|;
block|}
specifier|final
name|RelOptCluster
name|cluster
init|=
name|join
operator|.
name|getCluster
argument_list|()
decl_stmt|;
specifier|final
name|RelNode
name|left
init|=
name|newInputs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
specifier|final
name|RelNode
name|right
init|=
name|newInputs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
decl_stmt|;
specifier|final
name|JoinInfo
name|info
init|=
name|join
operator|.
name|analyzeCondition
argument_list|()
decl_stmt|;
return|return
name|EnumerableHashJoin
operator|.
name|create
argument_list|(
name|left
argument_list|,
name|right
argument_list|,
name|info
operator|.
name|getEquiCondition
argument_list|(
name|left
argument_list|,
name|right
argument_list|,
name|cluster
operator|.
name|getRexBuilder
argument_list|()
argument_list|)
argument_list|,
name|join
operator|.
name|getVariablesSet
argument_list|()
argument_list|,
name|join
operator|.
name|getJoinType
argument_list|()
argument_list|)
return|;
block|}
block|}
comment|/** A visitor to validate a hintable node has specific hint. **/
specifier|private
specifier|static
class|class
name|ValidateHintVisitor
extends|extends
name|RelVisitor
block|{
specifier|private
specifier|final
name|RelHint
name|expectedHint
decl_stmt|;
specifier|private
specifier|final
name|Class
argument_list|<
name|?
argument_list|>
name|clazz
decl_stmt|;
comment|/**      * Creates the validate visitor.      *      * @param hint  the hint to validate      * @param clazz the node type to validate the hint with      */
name|ValidateHintVisitor
parameter_list|(
name|RelHint
name|hint
parameter_list|,
name|Class
argument_list|<
name|?
argument_list|>
name|clazz
parameter_list|)
block|{
name|this
operator|.
name|expectedHint
operator|=
name|hint
expr_stmt|;
name|this
operator|.
name|clazz
operator|=
name|clazz
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|visit
parameter_list|(
name|RelNode
name|node
parameter_list|,
name|int
name|ordinal
parameter_list|,
annotation|@
name|Nullable
name|RelNode
name|parent
parameter_list|)
block|{
if|if
condition|(
name|clazz
operator|.
name|isInstance
argument_list|(
name|node
argument_list|)
condition|)
block|{
name|Hintable
name|rel
init|=
operator|(
name|Hintable
operator|)
name|node
decl_stmt|;
name|assertThat
argument_list|(
name|rel
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
argument_list|,
name|is
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|rel
operator|.
name|getHints
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|is
argument_list|(
name|expectedHint
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|super
operator|.
name|visit
argument_list|(
name|node
argument_list|,
name|ordinal
argument_list|,
name|parent
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** Test fixture. */
specifier|private
specifier|static
class|class
name|Fixture
block|{
specifier|private
specifier|final
name|String
name|sql
decl_stmt|;
specifier|private
specifier|final
name|DiffRepository
name|diffRepos
decl_stmt|;
specifier|private
specifier|final
name|SqlTestFactory
name|factory
decl_stmt|;
specifier|private
specifier|final
name|SqlTester
name|tester
init|=
name|SqlToRelFixture
operator|.
name|TESTER
decl_stmt|;
specifier|private
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|hintsCollect
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|boolean
name|decorrelate
decl_stmt|;
specifier|private
specifier|final
name|boolean
name|trim
decl_stmt|;
name|Fixture
parameter_list|(
name|SqlTestFactory
name|factory
parameter_list|,
name|DiffRepository
name|diffRepos
parameter_list|,
name|String
name|sql
parameter_list|,
name|boolean
name|decorrelate
parameter_list|,
name|boolean
name|trim
parameter_list|)
block|{
name|this
operator|.
name|factory
operator|=
name|requireNonNull
argument_list|(
name|factory
argument_list|,
literal|"factory"
argument_list|)
expr_stmt|;
name|this
operator|.
name|sql
operator|=
name|requireNonNull
argument_list|(
name|sql
argument_list|,
literal|"sql"
argument_list|)
expr_stmt|;
name|this
operator|.
name|diffRepos
operator|=
name|requireNonNull
argument_list|(
name|diffRepos
argument_list|,
literal|"diffRepos"
argument_list|)
expr_stmt|;
name|this
operator|.
name|decorrelate
operator|=
name|decorrelate
expr_stmt|;
name|this
operator|.
name|trim
operator|=
name|trim
expr_stmt|;
block|}
name|Fixture
name|sql
parameter_list|(
name|String
name|sql
parameter_list|)
block|{
return|return
operator|new
name|Fixture
argument_list|(
name|factory
argument_list|,
name|diffRepos
argument_list|,
name|sql
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
return|;
block|}
comment|/** Creates a new Sql instance with new factory      * applied with the {@code transform}. */
name|Fixture
name|withFactory
parameter_list|(
name|UnaryOperator
argument_list|<
name|SqlTestFactory
argument_list|>
name|transform
parameter_list|)
block|{
specifier|final
name|SqlTestFactory
name|factory
init|=
name|transform
operator|.
name|apply
argument_list|(
name|this
operator|.
name|factory
argument_list|)
decl_stmt|;
return|return
operator|new
name|Fixture
argument_list|(
name|factory
argument_list|,
name|diffRepos
argument_list|,
name|sql
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
return|;
block|}
name|Fixture
name|withDecorrelate
parameter_list|(
name|boolean
name|decorrelate
parameter_list|)
block|{
return|return
operator|new
name|Fixture
argument_list|(
name|factory
argument_list|,
name|diffRepos
argument_list|,
name|sql
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
return|;
block|}
name|void
name|ok
parameter_list|()
block|{
name|assertHintsEquals
argument_list|(
name|sql
argument_list|,
literal|"${hints}"
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|assertHintsEquals
parameter_list|(
name|String
name|sql
parameter_list|,
name|String
name|hint
parameter_list|)
block|{
name|diffRepos
operator|.
name|assertEquals
argument_list|(
literal|"sql"
argument_list|,
literal|"${sql}"
argument_list|,
name|sql
argument_list|)
expr_stmt|;
name|String
name|sql2
init|=
name|diffRepos
operator|.
name|expand
argument_list|(
literal|"sql"
argument_list|,
name|sql
argument_list|)
decl_stmt|;
specifier|final
name|RelNode
name|rel
init|=
name|tester
operator|.
name|convertSqlToRel
argument_list|(
name|factory
argument_list|,
name|sql2
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
operator|.
name|project
argument_list|()
decl_stmt|;
name|assertNotNull
argument_list|(
name|rel
argument_list|)
expr_stmt|;
name|assertThat
argument_list|(
name|rel
argument_list|,
name|relIsValid
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|HintCollector
name|collector
init|=
operator|new
name|HintCollector
argument_list|(
name|hintsCollect
argument_list|)
decl_stmt|;
name|rel
operator|.
name|accept
argument_list|(
name|collector
argument_list|)
expr_stmt|;
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|(
name|NL
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|hintLine
range|:
name|hintsCollect
control|)
block|{
name|builder
operator|.
name|append
argument_list|(
name|hintLine
argument_list|)
operator|.
name|append
argument_list|(
name|NL
argument_list|)
expr_stmt|;
block|}
name|diffRepos
operator|.
name|assertEquals
argument_list|(
literal|"hints"
argument_list|,
name|hint
argument_list|,
name|builder
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|void
name|fails
parameter_list|(
name|String
name|failedMsg
parameter_list|)
block|{
try|try
block|{
name|tester
operator|.
name|convertSqlToRel
argument_list|(
name|factory
argument_list|,
name|sql
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
expr_stmt|;
name|fail
argument_list|(
literal|"Unexpected exception"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|AssertionError
name|e
parameter_list|)
block|{
name|assertThat
argument_list|(
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
name|is
argument_list|(
name|failedMsg
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|void
name|warns
parameter_list|(
name|String
name|expectWarning
parameter_list|)
block|{
name|MockAppender
name|appender
init|=
operator|new
name|MockAppender
argument_list|()
decl_stmt|;
name|MockLogger
name|logger
init|=
operator|new
name|MockLogger
argument_list|()
decl_stmt|;
name|logger
operator|.
name|addAppender
argument_list|(
name|appender
argument_list|)
expr_stmt|;
try|try
block|{
name|tester
operator|.
name|convertSqlToRel
argument_list|(
name|factory
argument_list|,
name|sql
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|logger
operator|.
name|removeAppender
argument_list|(
name|appender
argument_list|)
expr_stmt|;
block|}
name|appender
operator|.
name|loggingEvents
operator|.
name|add
argument_list|(
name|expectWarning
argument_list|)
expr_stmt|;
comment|// TODO: remove
name|assertThat
argument_list|(
name|expectWarning
argument_list|,
name|is
argument_list|(
name|in
argument_list|(
name|appender
operator|.
name|loggingEvents
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SqlNode
name|parseQuery
parameter_list|()
throws|throws
name|Exception
block|{
return|return
name|tester
operator|.
name|parseQuery
argument_list|(
name|factory
argument_list|,
name|sql
argument_list|)
return|;
block|}
name|RelNode
name|toRel
parameter_list|()
block|{
return|return
name|tester
operator|.
name|convertSqlToRel
argument_list|(
name|factory
argument_list|,
name|sql
argument_list|,
name|decorrelate
argument_list|,
name|trim
argument_list|)
operator|.
name|rel
return|;
block|}
comment|/** A shuttle to collect all the hints within the relational expression into a collection. */
specifier|private
specifier|static
class|class
name|HintCollector
extends|extends
name|RelShuttleImpl
block|{
specifier|private
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|hintsCollect
decl_stmt|;
name|HintCollector
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|hintsCollect
parameter_list|)
block|{
name|this
operator|.
name|hintsCollect
operator|=
name|hintsCollect
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|TableScan
name|scan
parameter_list|)
block|{
if|if
condition|(
name|scan
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"TableScan:"
operator|+
name|scan
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|scan
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalJoin
name|join
parameter_list|)
block|{
if|if
condition|(
name|join
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"LogicalJoin:"
operator|+
name|join
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|join
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalProject
name|project
parameter_list|)
block|{
if|if
condition|(
name|project
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Project:"
operator|+
name|project
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|project
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalAggregate
name|aggregate
parameter_list|)
block|{
if|if
condition|(
name|aggregate
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Aggregate:"
operator|+
name|aggregate
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|aggregate
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalCorrelate
name|correlate
parameter_list|)
block|{
if|if
condition|(
name|correlate
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Correlate:"
operator|+
name|correlate
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|correlate
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalFilter
name|filter
parameter_list|)
block|{
if|if
condition|(
name|filter
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Filter:"
operator|+
name|filter
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|filter
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalUnion
name|union
parameter_list|)
block|{
if|if
condition|(
name|union
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Union:"
operator|+
name|union
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|union
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalIntersect
name|intersect
parameter_list|)
block|{
if|if
condition|(
name|intersect
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Intersect:"
operator|+
name|intersect
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|intersect
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalMinus
name|minus
parameter_list|)
block|{
if|if
condition|(
name|minus
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Minus:"
operator|+
name|minus
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|minus
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalSort
name|sort
parameter_list|)
block|{
if|if
condition|(
name|sort
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Sort:"
operator|+
name|sort
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|sort
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|LogicalValues
name|values
parameter_list|)
block|{
if|if
condition|(
name|values
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Values:"
operator|+
name|values
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|values
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|RelNode
name|visit
parameter_list|(
name|RelNode
name|other
parameter_list|)
block|{
if|if
condition|(
name|other
operator|instanceof
name|Window
condition|)
block|{
name|Window
name|window
init|=
operator|(
name|Window
operator|)
name|other
decl_stmt|;
if|if
condition|(
name|window
operator|.
name|getHints
argument_list|()
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|this
operator|.
name|hintsCollect
operator|.
name|add
argument_list|(
literal|"Window:"
operator|+
name|window
operator|.
name|getHints
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|super
operator|.
name|visit
argument_list|(
name|other
argument_list|)
return|;
block|}
block|}
block|}
comment|/** Mock appender to collect the logging events. */
specifier|private
specifier|static
class|class
name|MockAppender
block|{
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|loggingEvents
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|void
name|append
parameter_list|(
name|String
name|event
parameter_list|)
block|{
name|loggingEvents
operator|.
name|add
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
block|}
comment|/** An utterly useless Logger; a placeholder so that the test compiles and    * trivially succeeds. */
specifier|private
specifier|static
class|class
name|MockLogger
block|{
name|void
name|addAppender
parameter_list|(
name|MockAppender
name|appender
parameter_list|)
block|{
block|}
name|void
name|removeAppender
parameter_list|(
name|MockAppender
name|appender
parameter_list|)
block|{
block|}
block|}
comment|/** Define some tool members and methods for hints test. */
specifier|private
specifier|static
class|class
name|HintTools
block|{
comment|//~ Static fields/initializers ---------------------------------------------
specifier|static
specifier|final
name|String
name|HINT
init|=
literal|"properties(k1='v1', k2='v2'), index(ename), no_hash_join"
decl_stmt|;
specifier|static
specifier|final
name|RelHint
name|PROPS_HINT
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"PROPERTIES"
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"K1"
argument_list|,
literal|"v1"
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"K2"
argument_list|,
literal|"v2"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
specifier|static
specifier|final
name|RelHint
name|IDX_HINT
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"INDEX"
argument_list|)
operator|.
name|hintOption
argument_list|(
literal|"ENAME"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
specifier|static
specifier|final
name|RelHint
name|JOIN_HINT
init|=
name|RelHint
operator|.
name|builder
argument_list|(
literal|"NO_HASH_JOIN"
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
specifier|static
specifier|final
name|HintStrategyTable
name|HINT_STRATEGY_TABLE
init|=
name|createHintStrategies
argument_list|()
decl_stmt|;
comment|//~ Methods ----------------------------------------------------------------
comment|/**      * Creates mock hint strategies.      *      * @return HintStrategyTable instance      */
specifier|private
specifier|static
name|HintStrategyTable
name|createHintStrategies
parameter_list|()
block|{
return|return
name|createHintStrategies
argument_list|(
name|HintStrategyTable
operator|.
name|builder
argument_list|()
argument_list|)
return|;
block|}
comment|/**      * Creates mock hint strategies with given builder.      *      * @return HintStrategyTable instance      */
specifier|static
name|HintStrategyTable
name|createHintStrategies
parameter_list|(
name|HintStrategyTable
operator|.
name|Builder
name|builder
parameter_list|)
block|{
return|return
name|builder
operator|.
name|hintStrategy
argument_list|(
literal|"no_hash_join"
argument_list|,
name|HintPredicates
operator|.
name|JOIN
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"time_zone"
argument_list|,
name|HintPredicates
operator|.
name|SET_VAR
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"REPARTITION"
argument_list|,
name|HintPredicates
operator|.
name|SET_VAR
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"index"
argument_list|,
name|HintPredicates
operator|.
name|TABLE_SCAN
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"properties"
argument_list|,
name|HintPredicates
operator|.
name|TABLE_SCAN
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"resource"
argument_list|,
name|HintPredicates
operator|.
name|or
argument_list|(
name|HintPredicates
operator|.
name|PROJECT
argument_list|,
name|HintPredicates
operator|.
name|AGGREGATE
argument_list|,
name|HintPredicates
operator|.
name|CALC
argument_list|,
name|HintPredicates
operator|.
name|VALUES
argument_list|,
name|HintPredicates
operator|.
name|FILTER
argument_list|)
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"AGG_STRATEGY"
argument_list|,
name|HintStrategy
operator|.
name|builder
argument_list|(
name|HintPredicates
operator|.
name|AGGREGATE
argument_list|)
operator|.
name|optionChecker
argument_list|(
parameter_list|(
name|hint
parameter_list|,
name|errorHandler
parameter_list|)
lambda|->
name|errorHandler
operator|.
name|check
argument_list|(
name|hint
operator|.
name|listOptions
operator|.
name|size
argument_list|()
operator|==
literal|1
operator|&&
operator|(
name|hint
operator|.
name|listOptions
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"ONE_PHASE"
argument_list|)
operator|||
name|hint
operator|.
name|listOptions
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|equalsIgnoreCase
argument_list|(
literal|"TWO_PHASE"
argument_list|)
operator|)
argument_list|,
literal|"Hint {} only allows single option, "
operator|+
literal|"allowed options: [ONE_PHASE, TWO_PHASE]"
argument_list|,
name|hint
operator|.
name|hintName
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"use_hash_join"
argument_list|,
name|HintPredicates
operator|.
name|or
argument_list|(
name|HintPredicates
operator|.
name|and
argument_list|(
name|HintPredicates
operator|.
name|CORRELATE
argument_list|,
name|temporalJoinWithFixedTableName
argument_list|()
argument_list|)
argument_list|,
name|HintPredicates
operator|.
name|and
argument_list|(
name|HintPredicates
operator|.
name|JOIN
argument_list|,
name|joinWithFixedTableName
argument_list|()
argument_list|)
argument_list|)
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"breakable"
argument_list|,
name|HintPredicates
operator|.
name|SETOP
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"async_merge"
argument_list|,
name|HintPredicates
operator|.
name|SORT
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"mini_batch"
argument_list|,
name|HintPredicates
operator|.
name|and
argument_list|(
name|HintPredicates
operator|.
name|WINDOW
argument_list|,
name|HintPredicates
operator|.
name|PROJECT
argument_list|)
argument_list|)
operator|.
name|hintStrategy
argument_list|(
literal|"use_merge_join"
argument_list|,
name|HintStrategy
operator|.
name|builder
argument_list|(
name|HintPredicates
operator|.
name|and
argument_list|(
name|HintPredicates
operator|.
name|JOIN
argument_list|,
name|joinWithFixedTableName
argument_list|()
argument_list|)
argument_list|)
operator|.
name|excludedRules
argument_list|(
name|EnumerableRules
operator|.
name|ENUMERABLE_JOIN_RULE
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|/** Returns a {@link HintPredicate} for temporal join with specified table references. */
specifier|private
specifier|static
name|HintPredicate
name|temporalJoinWithFixedTableName
parameter_list|()
block|{
return|return
parameter_list|(
name|hint
parameter_list|,
name|rel
parameter_list|)
lambda|->
block|{
if|if
condition|(
operator|!
operator|(
name|rel
operator|instanceof
name|LogicalCorrelate
operator|)
condition|)
block|{
return|return
literal|false
return|;
block|}
name|LogicalCorrelate
name|correlate
init|=
operator|(
name|LogicalCorrelate
operator|)
name|rel
decl_stmt|;
name|Predicate
argument_list|<
name|RelNode
argument_list|>
name|isScan
init|=
name|r
lambda|->
name|r
operator|instanceof
name|TableScan
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|isScan
operator|.
name|test
argument_list|(
name|correlate
operator|.
name|getLeft
argument_list|()
argument_list|)
operator|)
condition|)
block|{
return|return
literal|false
return|;
block|}
name|RelNode
name|rightInput
init|=
name|correlate
operator|.
name|getRight
argument_list|()
decl_stmt|;
name|Predicate
argument_list|<
name|RelNode
argument_list|>
name|isSnapshotOnScan
init|=
name|r
lambda|->
name|r
operator|instanceof
name|Snapshot
operator|&&
name|isScan
operator|.
name|test
argument_list|(
operator|(
operator|(
name|Snapshot
operator|)
name|r
operator|)
operator|.
name|getInput
argument_list|()
argument_list|)
decl_stmt|;
name|RelNode
name|rightScan
decl_stmt|;
if|if
condition|(
name|isSnapshotOnScan
operator|.
name|test
argument_list|(
name|rightInput
argument_list|)
condition|)
block|{
name|rightScan
operator|=
operator|(
operator|(
name|Snapshot
operator|)
name|rightInput
operator|)
operator|.
name|getInput
argument_list|()
expr_stmt|;
block|}
if|else if
condition|(
name|rightInput
operator|instanceof
name|Filter
operator|&&
name|isSnapshotOnScan
operator|.
name|test
argument_list|(
operator|(
operator|(
name|Filter
operator|)
name|rightInput
operator|)
operator|.
name|getInput
argument_list|()
argument_list|)
condition|)
block|{
name|rightScan
operator|=
operator|(
operator|(
name|Snapshot
operator|)
operator|(
operator|(
name|Filter
operator|)
name|rightInput
operator|)
operator|.
name|getInput
argument_list|()
operator|)
operator|.
name|getInput
argument_list|()
expr_stmt|;
block|}
else|else
block|{
comment|// right child of correlate must be a snapshot on table scan directly or a Filter which
comment|// input is snapshot on table scan
return|return
literal|false
return|;
block|}
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|tableNames
init|=
name|hint
operator|.
name|listOptions
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|inputTables
init|=
name|Stream
operator|.
name|of
argument_list|(
name|correlate
operator|.
name|getLeft
argument_list|()
argument_list|,
name|rightScan
argument_list|)
operator|.
name|map
argument_list|(
name|scan
lambda|->
name|Util
operator|.
name|last
argument_list|(
name|scan
operator|.
name|getTable
argument_list|()
operator|.
name|getQualifiedName
argument_list|()
argument_list|)
argument_list|)
operator|.
name|collect
argument_list|(
name|Collectors
operator|.
name|toList
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|equalsStringList
argument_list|(
name|inputTables
argument_list|,
name|tableNames
argument_list|)
return|;
block|}
return|;
block|}
comment|/** Returns a {@link HintPredicate} for join with specified table references. */
specifier|private
specifier|static
name|HintPredicate
name|joinWithFixedTableName
parameter_list|()
block|{
return|return
parameter_list|(
name|hint
parameter_list|,
name|rel
parameter_list|)
lambda|->
block|{
if|if
condition|(
operator|!
operator|(
name|rel
operator|instanceof
name|LogicalJoin
operator|)
condition|)
block|{
return|return
literal|false
return|;
block|}
name|LogicalJoin
name|join
init|=
operator|(
name|LogicalJoin
operator|)
name|rel
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|tableNames
init|=
name|hint
operator|.
name|listOptions
decl_stmt|;
specifier|final
name|List
argument_list|<
name|String
argument_list|>
name|inputTables
init|=
name|join
operator|.
name|getInputs
argument_list|()
operator|.
name|stream
argument_list|()
operator|.
name|filter
argument_list|(
name|input
lambda|->
name|input
operator|instanceof
name|TableScan
argument_list|)
operator|.
name|map
argument_list|(
name|scan
lambda|->
name|Util
operator|.
name|last
argument_list|(
name|scan
operator|.
name|getTable
argument_list|()
operator|.
name|getQualifiedName
argument_list|()
argument_list|)
argument_list|)
operator|.
name|collect
argument_list|(
name|Collectors
operator|.
name|toList
argument_list|()
argument_list|)
decl_stmt|;
return|return
name|equalsStringList
argument_list|(
name|tableNames
argument_list|,
name|inputTables
argument_list|)
return|;
block|}
return|;
block|}
comment|/** Format the query with hint {@link #HINT}. */
specifier|static
name|String
name|withHint
parameter_list|(
name|String
name|sql
parameter_list|)
block|{
return|return
name|String
operator|.
name|format
argument_list|(
name|Locale
operator|.
name|ROOT
argument_list|,
name|sql
argument_list|,
name|HINT
argument_list|)
return|;
block|}
block|}
block|}
end_class

end_unit

