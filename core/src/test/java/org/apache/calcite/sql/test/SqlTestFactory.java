begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to you under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  * http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|test
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|avatica
operator|.
name|util
operator|.
name|Casing
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|avatica
operator|.
name|util
operator|.
name|Quoting
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|jdbc
operator|.
name|JavaTypeFactoryImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|type
operator|.
name|DelegatingTypeSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|type
operator|.
name|RelDataTypeFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|rel
operator|.
name|type
operator|.
name|RelDataTypeSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|SqlOperatorTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|advise
operator|.
name|SqlAdvisor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|fun
operator|.
name|SqlStdOperatorTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|parser
operator|.
name|SqlParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|validate
operator|.
name|SqlConformance
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|validate
operator|.
name|SqlConformanceEnum
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|validate
operator|.
name|SqlValidator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|validate
operator|.
name|SqlValidatorCatalogReader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|validate
operator|.
name|SqlValidatorUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|sql
operator|.
name|validate
operator|.
name|SqlValidatorWithHints
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
operator|.
name|CalciteAssert
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
operator|.
name|MockSqlOperatorTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
operator|.
name|catalog
operator|.
name|MockCatalogReader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|calcite
operator|.
name|test
operator|.
name|catalog
operator|.
name|MockCatalogReaderSimple
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableMap
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableSortedMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Objects
import|;
end_import

begin_comment
comment|/**  * Default implementation of {@link SqlTestFactory}.  *  *<p>Suitable for most tests. If you want different behavior, you can extend;  * if you want a factory with different properties (e.g. SQL conformance level  * or identifier quoting), use {@link #with(String, Object)} to create a new factory.</p> */
end_comment

begin_class
specifier|public
class|class
name|SqlTestFactory
block|{
specifier|public
specifier|static
specifier|final
name|ImmutableMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|DEFAULT_OPTIONS
init|=
name|ImmutableSortedMap
operator|.
expr|<
name|String
decl_stmt|,
name|Object
decl|>
name|naturalOrder
argument_list|()
decl|.
name|put
argument_list|(
literal|"quoting"
argument_list|,
name|Quoting
operator|.
name|DOUBLE_QUOTE
argument_list|)
decl|.
name|put
argument_list|(
literal|"quotedCasing"
argument_list|,
name|Casing
operator|.
name|UNCHANGED
argument_list|)
decl|.
name|put
argument_list|(
literal|"unquotedCasing"
argument_list|,
name|Casing
operator|.
name|TO_UPPER
argument_list|)
decl|.
name|put
argument_list|(
literal|"caseSensitive"
argument_list|,
literal|true
argument_list|)
decl|.
name|put
argument_list|(
literal|"conformance"
argument_list|,
name|SqlConformanceEnum
operator|.
name|DEFAULT
argument_list|)
decl|.
name|put
argument_list|(
literal|"operatorTable"
argument_list|,
name|SqlStdOperatorTable
operator|.
name|instance
argument_list|()
argument_list|)
decl|.
name|put
argument_list|(
literal|"connectionFactory"
argument_list|,
name|CalciteAssert
operator|.
name|EMPTY_CONNECTION_FACTORY
operator|.
name|with
argument_list|(
operator|new
name|CalciteAssert
operator|.
name|AddSchemaSpecPostProcessor
argument_list|(
name|CalciteAssert
operator|.
name|SchemaSpec
operator|.
name|HR
argument_list|)
argument_list|)
argument_list|)
decl|.
name|build
argument_list|()
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|SqlTestFactory
name|INSTANCE
init|=
operator|new
name|SqlTestFactory
argument_list|()
decl_stmt|;
specifier|private
specifier|final
name|ImmutableMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|options
decl_stmt|;
specifier|private
specifier|final
name|MockCatalogReaderFactory
name|catalogReaderFactory
decl_stmt|;
specifier|private
specifier|final
name|ValidatorFactory
name|validatorFactory
decl_stmt|;
specifier|private
specifier|final
name|RelDataTypeFactory
name|typeFactory
decl_stmt|;
specifier|private
specifier|final
name|SqlOperatorTable
name|operatorTable
decl_stmt|;
specifier|private
specifier|final
name|SqlValidatorCatalogReader
name|catalogReader
decl_stmt|;
specifier|private
specifier|final
name|SqlParser
operator|.
name|Config
name|parserConfig
decl_stmt|;
specifier|protected
name|SqlTestFactory
parameter_list|()
block|{
name|this
argument_list|(
name|DEFAULT_OPTIONS
argument_list|,
name|MockCatalogReaderSimple
operator|::
operator|new
argument_list|,
name|SqlValidatorUtil
operator|::
name|newValidator
argument_list|)
expr_stmt|;
block|}
specifier|protected
name|SqlTestFactory
parameter_list|(
name|ImmutableMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|options
parameter_list|,
name|MockCatalogReaderFactory
name|catalogReaderFactory
parameter_list|,
name|ValidatorFactory
name|validatorFactory
parameter_list|)
block|{
name|this
operator|.
name|options
operator|=
name|options
expr_stmt|;
name|this
operator|.
name|catalogReaderFactory
operator|=
name|catalogReaderFactory
expr_stmt|;
name|this
operator|.
name|validatorFactory
operator|=
name|validatorFactory
expr_stmt|;
name|this
operator|.
name|operatorTable
operator|=
name|createOperatorTable
argument_list|(
operator|(
name|SqlOperatorTable
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"operatorTable"
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|typeFactory
operator|=
name|createTypeFactory
argument_list|(
operator|(
name|SqlConformance
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"conformance"
argument_list|)
argument_list|)
expr_stmt|;
name|Boolean
name|caseSensitive
init|=
operator|(
name|Boolean
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"caseSensitive"
argument_list|)
decl_stmt|;
name|this
operator|.
name|catalogReader
operator|=
name|catalogReaderFactory
operator|.
name|create
argument_list|(
name|typeFactory
argument_list|,
name|caseSensitive
argument_list|)
operator|.
name|init
argument_list|()
expr_stmt|;
name|this
operator|.
name|parserConfig
operator|=
name|createParserConfig
argument_list|(
name|options
argument_list|)
expr_stmt|;
block|}
specifier|public
specifier|static
name|MockCatalogReader
name|createCatalogReader
parameter_list|(
name|RelDataTypeFactory
name|typeFactory
parameter_list|,
name|boolean
name|caseSensitive
parameter_list|)
block|{
return|return
operator|new
name|MockCatalogReaderSimple
argument_list|(
name|typeFactory
argument_list|,
name|caseSensitive
argument_list|)
operator|.
name|init
argument_list|()
return|;
block|}
specifier|private
specifier|static
name|SqlOperatorTable
name|createOperatorTable
parameter_list|(
name|SqlOperatorTable
name|opTab0
parameter_list|)
block|{
name|MockSqlOperatorTable
name|opTab
init|=
operator|new
name|MockSqlOperatorTable
argument_list|(
name|opTab0
argument_list|)
decl_stmt|;
name|MockSqlOperatorTable
operator|.
name|addRamp
argument_list|(
name|opTab
argument_list|)
expr_stmt|;
return|return
name|opTab
return|;
block|}
specifier|public
name|SqlParser
name|createParser
parameter_list|(
name|String
name|sql
parameter_list|)
block|{
return|return
name|SqlParser
operator|.
name|create
argument_list|(
name|sql
argument_list|,
name|parserConfig
argument_list|)
return|;
block|}
specifier|public
specifier|static
name|SqlParser
operator|.
name|Config
name|createParserConfig
parameter_list|(
name|ImmutableMap
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|options
parameter_list|)
block|{
return|return
name|SqlParser
operator|.
name|configBuilder
argument_list|()
operator|.
name|setQuoting
argument_list|(
operator|(
name|Quoting
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"quoting"
argument_list|)
argument_list|)
operator|.
name|setUnquotedCasing
argument_list|(
operator|(
name|Casing
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"unquotedCasing"
argument_list|)
argument_list|)
operator|.
name|setQuotedCasing
argument_list|(
operator|(
name|Casing
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"quotedCasing"
argument_list|)
argument_list|)
operator|.
name|setConformance
argument_list|(
operator|(
name|SqlConformance
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"conformance"
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
specifier|public
name|SqlValidator
name|getValidator
parameter_list|()
block|{
specifier|final
name|SqlConformance
name|conformance
init|=
operator|(
name|SqlConformance
operator|)
name|options
operator|.
name|get
argument_list|(
literal|"conformance"
argument_list|)
decl_stmt|;
return|return
name|validatorFactory
operator|.
name|create
argument_list|(
name|operatorTable
argument_list|,
name|catalogReader
argument_list|,
name|typeFactory
argument_list|,
name|conformance
argument_list|)
return|;
block|}
specifier|public
name|SqlAdvisor
name|createAdvisor
parameter_list|()
block|{
name|SqlValidator
name|validator
init|=
name|getValidator
argument_list|()
decl_stmt|;
if|if
condition|(
name|validator
operator|instanceof
name|SqlValidatorWithHints
condition|)
block|{
return|return
operator|new
name|SqlAdvisor
argument_list|(
operator|(
name|SqlValidatorWithHints
operator|)
name|validator
argument_list|)
return|;
block|}
throw|throw
operator|new
name|UnsupportedOperationException
argument_list|(
literal|"Validator should implement SqlValidatorWithHints, actual validator is "
operator|+
name|validator
argument_list|)
throw|;
block|}
specifier|public
name|SqlTestFactory
name|with
parameter_list|(
name|String
name|name
parameter_list|,
name|Object
name|value
parameter_list|)
block|{
if|if
condition|(
name|Objects
operator|.
name|equals
argument_list|(
name|value
argument_list|,
name|options
operator|.
name|get
argument_list|(
name|name
argument_list|)
argument_list|)
condition|)
block|{
return|return
name|this
return|;
block|}
name|ImmutableMap
operator|.
name|Builder
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|builder
init|=
name|ImmutableSortedMap
operator|.
name|naturalOrder
argument_list|()
decl_stmt|;
comment|// Protect from IllegalArgumentException: Multiple entries with same key
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|Object
argument_list|>
name|entry
range|:
name|options
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
name|name
operator|.
name|equals
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|builder
operator|.
name|put
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|put
argument_list|(
name|name
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|new
name|SqlTestFactory
argument_list|(
name|builder
operator|.
name|build
argument_list|()
argument_list|,
name|catalogReaderFactory
argument_list|,
name|validatorFactory
argument_list|)
return|;
block|}
specifier|public
name|SqlTestFactory
name|withCatalogReader
parameter_list|(
name|MockCatalogReaderFactory
name|newCatalogReaderFactory
parameter_list|)
block|{
return|return
operator|new
name|SqlTestFactory
argument_list|(
name|options
argument_list|,
name|newCatalogReaderFactory
argument_list|,
name|validatorFactory
argument_list|)
return|;
block|}
specifier|public
name|SqlTestFactory
name|withValidator
parameter_list|(
name|ValidatorFactory
name|newValidatorFactory
parameter_list|)
block|{
return|return
operator|new
name|SqlTestFactory
argument_list|(
name|options
argument_list|,
name|catalogReaderFactory
argument_list|,
name|newValidatorFactory
argument_list|)
return|;
block|}
specifier|public
specifier|final
name|Object
name|get
parameter_list|(
name|String
name|name
parameter_list|)
block|{
return|return
name|options
operator|.
name|get
argument_list|(
name|name
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|RelDataTypeFactory
name|createTypeFactory
parameter_list|(
name|SqlConformance
name|conformance
parameter_list|)
block|{
name|RelDataTypeSystem
name|typeSystem
init|=
name|RelDataTypeSystem
operator|.
name|DEFAULT
decl_stmt|;
if|if
condition|(
name|conformance
operator|.
name|shouldConvertRaggedUnionTypesToVarying
argument_list|()
condition|)
block|{
name|typeSystem
operator|=
operator|new
name|DelegatingTypeSystem
argument_list|(
name|typeSystem
argument_list|)
block|{
specifier|public
name|boolean
name|shouldConvertRaggedUnionTypesToVarying
parameter_list|()
block|{
return|return
literal|true
return|;
block|}
block|}
expr_stmt|;
block|}
return|return
operator|new
name|JavaTypeFactoryImpl
argument_list|(
name|typeSystem
argument_list|)
return|;
block|}
comment|/**    * Creates {@link SqlValidator} for tests.    */
specifier|public
interface|interface
name|ValidatorFactory
block|{
name|SqlValidator
name|create
parameter_list|(
name|SqlOperatorTable
name|opTab
parameter_list|,
name|SqlValidatorCatalogReader
name|catalogReader
parameter_list|,
name|RelDataTypeFactory
name|typeFactory
parameter_list|,
name|SqlConformance
name|conformance
parameter_list|)
function_decl|;
block|}
comment|/**    * Creates {@link MockCatalogReader} for tests.    * Note: {@link MockCatalogReader#init()} is to be invoked later, so a typical implementation    * should be via constructor reference like {@code MockCatalogReaderSimple::new}.    */
specifier|public
interface|interface
name|MockCatalogReaderFactory
block|{
name|MockCatalogReader
name|create
parameter_list|(
name|RelDataTypeFactory
name|typeFactory
parameter_list|,
name|boolean
name|caseSensitive
parameter_list|)
function_decl|;
block|}
block|}
end_class

begin_comment
comment|// End SqlTestFactory.java
end_comment

end_unit

